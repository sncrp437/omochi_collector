{% extends "admin/multilingual_change_form_base.html" %}

{% comment %}
Multilingual admin form for Venue model with inline VenueQuestion translation support.
Uses AJAX translation to avoid page reloads and preserve newly added inline forms.
{% endcomment %}

{% block admin_change_form_document_ready %}
    {{ block.super }}
    
    <script>
    (function($) {
        $(document).ready(function() {
            /**
             * Add translation buttons next to venue question English fields
             * These buttons perform AJAX translation without page reload
             */
            function addInlineTranslateButtons() {
                // Look for both standard and simplified inline field patterns
                // Exclude template fields (containing __prefix__)
                $('input[name$="-question_en"], input[name*="questions-"][name$="_en"]').each(function() {
                    var $questionEnField = $(this);
                    var questionEnName = $questionEnField.attr('name');
                    
                    // Skip template fields (Django uses __prefix__ as placeholder)
                    if (questionEnName.includes('__prefix__')) {
                        return;
                    }
                    
                    // Skip if translate button already exists
                    if ($questionEnField.siblings('.inline-translate-btn').length > 0) {
                        return;
                    }
                    
                    // Find the corresponding Japanese question field
                    var questionName = questionEnName.replace('_en', '');
                    var $questionField = $('input[name="' + questionName + '"]');
                    
                    if ($questionField.length > 0) {
                        // Create translate button with consistent styling
                        var $translateBtn = $('<button type="button" class="inline-translate-btn" style="margin: 0px 5px; min-height: 26px; padding: 4px 8px; background: #007cba; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer; vertical-align: middle;">üîÑ</button>');
                        
                        // Set button data attributes for translation handling
                        $translateBtn.attr({
                            'data-source': questionName,
                            'data-target': questionEnName,
                            'title': 'Translate question to English'
                        });
                        
                        // Add button next to English question field
                        $questionEnField.after($translateBtn);
                    }
                });
            }
            
            /**
             * Handle AJAX translation without page reload
             * This prevents loss of newly added inline forms
             */
            function handleInlineTranslationClick(e) {
                e.preventDefault();
                
                const button = $(this);
                const sourceField = button.data('source');
                const targetField = button.data('target');
                const sourceInput = $('#id_' + sourceField);
                const targetInput = $('#id_' + targetField);
                const sourceText = sourceInput.val().trim();
                
                // Validate source text exists
                if (!sourceText) {
                    alert('Please enter text in the Japanese question field first');
                    return;
                }
                
                // Show loading state
                const originalText = button.html();
                button.prop('disabled', true).html('‚è≥');
                
                // Perform AJAX translation
                $.ajax({
                    url: window.location.href,
                    method: 'POST',
                    data: {
                        'translate_action': 'ajax',
                        'translate_field': 'question',
                        'translate_text': sourceText,
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Update the English field with translation
                            targetInput.val(response.translated_text);
                            
                            // Show success message
                            showTranslationMessage('success', 'Translation successful: ' + response.translated_text.substring(0, 50) + '...');
                        } else {
                            showTranslationMessage('error', 'Translation failed: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        showTranslationMessage('error', 'Translation request failed: ' + error);
                    },
                    complete: function() {
                        // Restore button state
                        button.prop('disabled', false).html(originalText);
                    }
                });
            }
            
            /**
             * Show translation message to user
             */
            function showTranslationMessage(type, message) {
                // Remove any existing messages
                $('.translation-message').remove();
                
                // Create message element
                var messageClass = type === 'success' ? 'success' : 'error';
                var $message = $('<div class="translation-message alert alert-' + messageClass + '" style="margin: 10px 0; padding: 10px; border-radius: 4px; ' + 
                    (type === 'success' ? 'background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : 
                                         'background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;') + '">' + 
                    message + '</div>');
                
                // Add message at the top of the form
                $('.form-row').first().before($message);
                
                // Auto-remove after 5 seconds
                setTimeout(function() {
                    $message.fadeOut(function() {
                        $message.remove();
                    });
                }, 5000);
            }
            
            // Initialize inline translation buttons
            addInlineTranslateButtons();
            
            // Handle dynamic inline form addition (Django admin adds forms dynamically)
            // Use MutationObserver for better performance and modern browsers
            if (window.MutationObserver) {
                var observer = new MutationObserver(function(mutations) {
                    var shouldUpdate = false;
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // Check if any added nodes contain input fields
                            for (var i = 0; i < mutation.addedNodes.length; i++) {
                                var node = mutation.addedNodes[i];
                                if (node.nodeType === 1) { // Element node
                                    var hasInputs = node.tagName === 'INPUT' || 
                                                  (node.querySelector && node.querySelector('input'));
                                    if (hasInputs) {
                                        shouldUpdate = true;
                                        break;
                                    }
                                }
                            }
                        }
                    });
                    
                    if (shouldUpdate) {
                        setTimeout(addInlineTranslateButtons, 100);
                    }
                });
                
                // Start observing
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            } else {
                // Fallback for older browsers
                $(document).on('DOMNodeInserted', function() {
                    setTimeout(addInlineTranslateButtons, 100);
                });
            }
            
            // Bind click handler for inline translation buttons
            $(document).on('click', '.inline-translate-btn', handleInlineTranslationClick);
        });
    })(django.jQuery);
    </script>
{% endblock %}
