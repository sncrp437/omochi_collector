{% extends "admin/change_form.html" %}
{% comment %}
Base template for multilingual admin forms with translation functionality.
This template provides:
1. CSS styles for translation buttons and messages
2. JavaScript for translation button handling
3. Scroll position preservation during form submissions

Usage: Create app-specific templates that extend this base template:
{% extends "admin/multilingual_change_form_base.html" %}
{% endcomment %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .translate-btn {
            padding: 5px 10px;
            margin-top: 10px;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .translate-btn[disabled] {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        .translate-btn:hover:not([disabled]) {
            background-color: #005a87;
        }
        .translation-message {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .translation-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .translation-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Disable translate button on add form
        var isAdd = "{{ add|yesno:'true,false' }}" === "true";
        if (isAdd) {
            var btns = document.querySelectorAll('.translate-btn');
            btns.forEach(function(btn) {
                btn.disabled = true;
                btn.title = 'Translation is only available when updating.';
                // English comment for clarity
            });
        }
    });
    </script>
{% endblock %}

{% block admin_change_form_document_ready %}
    {{ block.super }}
    
    {% if translation_cache %}
    <script type="application/json" id="translation-cache">
        {
        {% for field_name, translated_text in translation_cache.items %}
            "{{ field_name|escapejs }}": "{{ translated_text|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
        }
    </script>
    {% endif %}
    
    <script>
        (function($) {
            // Restore scroll position after page load
            $(document).ready(function() {
                const savedScrollPosition = sessionStorage.getItem('scrollPosition');
                if (savedScrollPosition) {
                    window.scrollTo(0, parseInt(savedScrollPosition));
                    sessionStorage.removeItem('scrollPosition'); // Clean up
                }
                
                // Always fill fields from cache on add form, regardless of current value
                const cacheScript = document.getElementById('translation-cache');
                const isAfterTranslation = sessionStorage.getItem('afterTranslation');
                // Detect if this is the add form (URL ends with /add/)
                const isAddForm = window.location.pathname.endsWith('/add/') || window.location.pathname.includes('_add');
                if (cacheScript && !isAfterTranslation && isAddForm) {
                    try {
                        const translationCache = JSON.parse(cacheScript.textContent);
                        for (const fieldName in translationCache) {
                            const fieldInput = $('#id_' + fieldName);
                            const translatedText = translationCache[fieldName];
                            // If the field is English (_en), always fill from cache
                            if (fieldName.endsWith('_en')) {
                                if (fieldInput.length && translatedText.trim()) {
                                    fieldInput.val(translatedText);
                                }
                            } else {
                                // For Japanese fields: only fill if input is empty
                                if (fieldInput.length && !fieldInput.val().trim() && translatedText.trim()) {
                                    fieldInput.val(translatedText);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing translation cache:', e);
                    }
                }
                // Clean up translation flag
                if (isAfterTranslation) {
                    sessionStorage.removeItem('afterTranslation');
                }
            });

            // Handle translation button clicks - NO AJAX, just form submission
            $(document).on('click', '.translate-btn', function(e) {
                e.preventDefault();
                
                const button = $(this);
                const sourceField = button.data('source');
                const targetField = button.data('target');
                const sourceInput = $('#id_' + sourceField);
                
                // Get source text
                const sourceText = sourceInput.val().trim();
                if (!sourceText) {
                    alert('Please enter text in the ' + sourceField + ' field first');
                    return;
                }

                // Save current scroll position before form submission
                sessionStorage.setItem('scrollPosition', window.pageYOffset);
                
                // Mark that we're doing a translation to prevent cache interference
                sessionStorage.setItem('afterTranslation', 'true');
                
                // Create hidden inputs for translation request
                const form = $('form[method="post"]');
                
                // Remove existing translation inputs
                form.find('input[name="translate_action"]').remove();
                form.find('input[name="translate_field"]').remove();
                form.find('input[name="translate_text"]').remove();
                
                // Add hidden inputs properly without encoding
                const actionInput = $('<input type="hidden" name="translate_action">').val('true');
                const fieldInput = $('<input type="hidden" name="translate_field">').val(sourceField);
                const textInput = $('<input type="hidden" name="translate_text">').val(sourceText);
                
                form.append(actionInput);
                form.append(fieldInput);  
                form.append(textInput);
                
                // Show loading state
                button.prop('disabled', true).html('‚è≥ Translating...');
                
                // Submit form
                form.submit();
            });
            
            // Handle inline translation button clicks (for venue questions, etc.)
            $(document).on('click', '.inline-translate-btn', function(e) {
                e.preventDefault();
                
                // Save current scroll position before form submission
                sessionStorage.setItem('scrollPosition', window.pageYOffset);
                
                // Mark that we're doing a translation to prevent cache interference
                sessionStorage.setItem('afterTranslation', 'true');
                
                // Let the specific template handle the rest of the logic
                // This ensures scroll position is preserved for inline translations
            });
        })(django.jQuery);
    </script>
{% endblock %}