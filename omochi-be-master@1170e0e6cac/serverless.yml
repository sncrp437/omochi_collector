app: omochi
service: omochi

provider:
  name: aws
  runtime: python3.13
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-northeast-1'}
  profile: ${env:AWS_PROFILE, 'omochi-dev'}
  
  # Enable API Gateway logging to CloudWatch
  apiGateway:
    metrics: true
    # Add binary media types configuration for handling file uploads
    binaryMediaTypes:
      - 'image/jpeg'
      - 'image/png'
      - 'image/gif'
      - 'application/pdf'
      - 'application/octet-stream'
      - 'multipart/form-data'
      - '*/*'
  
  environment:
    DJANGO_SETTINGS_MODULE: 'omochi.settings'
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    DB_HOST: ${env:DB_HOST}
    CORS_ALLOWED_ORIGINS: ${env:CORS_ALLOWED_ORIGINS}
    CORS_ALLOW_CREDENTIALS: ${env:CORS_ALLOW_CREDENTIALS}
    CORS_ALLOW_ALL_ORIGINS: ${env:CORS_ALLOW_ALL_ORIGINS}
    STRIPE_PUBLISHABLE_KEY: ${env:STRIPE_PUBLISHABLE_KEY}
    STRIPE_SECRET_KEY: ${env:STRIPE_SECRET_KEY}
    STRIPE_CONNECT_WEBHOOK_SECRET: ${env:STRIPE_CONNECT_WEBHOOK_SECRET, ''}
    STRIPE_API_VERSION: ${env:STRIPE_API_VERSION}
    FRONTEND_URL: ${env:FRONTEND_URL}
    STRIPE_CONNECTED_ACCOUNT_COUNTRY: ${env:STRIPE_CONNECTED_ACCOUNT_COUNTRY, 'JP'}
    USE_S3: 'True'
    AWS_STORAGE_BUCKET_NAME: ${env:AWS_STORAGE_BUCKET_NAME, 'omochi-${self:provider.stage}-static'}
    # Add log level environment variables
    LOG_LEVEL: ${env:LOG_LEVEL, 'INFO'}
    PYTHONUNBUFFERED: '1'
    DEBUG: ${env:DEBUG, 'False'}
    # Email configuration
    EMAIL_BACKEND: ${env:EMAIL_BACKEND, 'django.core.mail.backends.smtp.EmailBackend'}
    EMAIL_HOST: ${env:EMAIL_HOST, 'smtp.gmail.com'}
    EMAIL_PORT: ${env:EMAIL_PORT, '587'}
    EMAIL_USE_TLS: ${env:EMAIL_USE_TLS, 'True'}
    EMAIL_HOST_USER: ${env:EMAIL_HOST_USER, ''}
    EMAIL_HOST_PASSWORD: ${env:EMAIL_HOST_PASSWORD, ''}
    FIREBASE_CREDENTIALS_JSON: ${env:FIREBASE_CREDENTIALS_JSON, ''}
    FIREBASE_PROJECT_ID: ${env:FIREBASE_PROJECT_ID, ''}
    DEFAULT_FROM_EMAIL: ${env:DEFAULT_FROM_EMAIL, 'noreply@omochi.app'}
    INVOICE_BCC_EMAIL: ${env:INVOICE_BCC_EMAIL, 'info@omochi.app'}
    DJANGO_SECRET_KEY: ${env:DJANGO_SECRET_KEY, 'secure_key'}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}

  # VPC Configuration
  vpc:
    securityGroupIds:
      - ${env:VPC_SECURITY_GROUP_ID}
    subnetIds:
      - ${env:VPC_SUBNET_ID_1}
      - ${env:VPC_SUBNET_ID_2}

  # Add IAM role statements for S3 access
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:ListBucket
            - s3:DeleteObject
            - s3:PutObjectAcl
          Resource:
            - "arn:aws:s3:::${self:custom.staticBucketName}/*"
            - "arn:aws:s3:::${self:custom.staticBucketName}"
        # Add permissions for VPC access
        - Effect: Allow
          Action:
            - ec2:CreateNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface
            - ec2:AssignPrivateIpAddresses
            - ec2:UnassignPrivateIpAddresses
          Resource: "*"
        # Add CloudWatch logs permissions
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            - logs:DescribeLogGroups
            - logs:DescribeLogStreams
            - logs:GetLogEvents
            - logs:FilterLogEvents
          Resource: 
            - "arn:aws:logs:${self:provider.region}:*:*"

package:
  patterns:
    - '!node_modules/**'
    - '!.env'
    - '!.git/**'
    - '!__pycache__/**'
    - '!*.pyc'
    - '!.DS_Store'
    - '!.serverless/**'
    - '!.vscode/**'
    - '!.pytest_cache/**'
    - '!tests/**'
    - '!.venv/**'

functions:
  api:
    name: omochi-${self:provider.stage}-api
    handler: wsgi_handler.handler
    events:
      - http: ANY /
      - http: ANY /{proxy+}
    # Add command to collect static files when deploying
    package:
      patterns:
        - 'staticfiles/**'

plugins:
  - serverless-python-requirements
  - serverless-wsgi

custom:
  wsgi:
    app: omochi.wsgi.application
    packRequirements: false
    # Add collectStatic option to run Django's collectstatic command
    # during deployment
    pythonBin: python
    commands:
      collectStatic: manage.py collectstatic --noinput
  pythonRequirements:
    dockerizePip: non-linux
    zip: true
  # Update custom variables for AWS S3 configuration
  staticBucketName: ${self:resources.Resources.StaticBucket.Properties.BucketName}

# Add CloudFormation Resources section to create the S3 bucket
resources:
  Resources:
    # Create API Gateway CloudWatch logging role and policy
    ApiGatewayCloudWatchLogsRole:
      Type: 'AWS::IAM::Role'
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - apigateway.amazonaws.com
              Action: 'sts:AssumeRole'
        ManagedPolicyArns:
          - 'arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs'
        Path: '/'
    
    # Set up API Gateway account settings to use the role
    ApiGatewayAccount:
      Type: 'AWS::ApiGateway::Account'
      Properties:
        CloudWatchRoleArn: !GetAtt ApiGatewayCloudWatchLogsRole.Arn
      DependsOn:
        - ApiGatewayCloudWatchLogsRole
        
    StaticBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: omochi-${self:provider.stage}-static
        # Remove AccessControl: PublicRead as it's not compatible with default ObjectOwnership settings
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        OwnershipControls:
          Rules:
            - ObjectOwnership: ObjectWriter  # Use ObjectWriter instead of BucketOwnerEnforced
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET, PUT, POST, DELETE, HEAD]
              AllowedOrigins: ['*']
              MaxAge: 3000
        WebsiteConfiguration:
          IndexDocument: index.html
          ErrorDocument: error.html
    
    # Add bucket policy to make content publicly accessible
    StaticBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref StaticBucket
        PolicyDocument:
          Statement:
            - Sid: PublicReadGetObject
              Effect: Allow
              Principal: '*'
              Action:
                - s3:GetObject
              Resource: !Join ['', ['arn:aws:s3:::', !Ref StaticBucket, '/*']]
  
  # Define outputs to be used in other services/templates
  Outputs:
    StaticBucketName:
      Value: !Ref StaticBucket
      Export:
        Name: ${self:service}-${self:provider.stage}-StaticBucketName
    StaticBucketDomainName:
      Value: !GetAtt StaticBucket.DomainName
      Export:
        Name: ${self:service}-${self:provider.stage}-StaticBucketDomainName
    StaticBucketWebsiteURL:
      Value: !GetAtt StaticBucket.WebsiteURL
      Export:
        Name: ${self:service}-${self:provider.stage}-StaticBucketWebsiteURL